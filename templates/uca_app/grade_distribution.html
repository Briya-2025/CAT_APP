{% extends 'base.html' %}
{% load grade_filters %}

{% block title %}Grade Distribution - {{ course.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">{{ course.name }}</h2>
                            <p class="text-muted mb-0">{{ course.code }} - {{ course.term_semester }}</p>
                            <p class="text-muted mb-0">Step 5: Grade Distribution</p>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'uca_app:course_detail' course.id %}" class="btn btn-secondary me-2">
                                <i class="fas fa-arrow-left"></i> Back to Course
                            </a>
                            <a href="{% url 'uca_app:course_report' course.id %}" class="btn btn-success">
                                <i class="fas fa-arrow-right me-2"></i>Next: Generate Report
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Grade Distribution Management -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                            <i class="fas fa-edit me-2"></i>Enter Grade Distribution Data
                    </h4>
                        <a href="{% url 'uca_app:edit_grade_categories' course.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-cog me-2"></i>Edit Grade Categories
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="gradeForm">
                        {% csrf_token %}
                        <input type="hidden" name="grade_data" id="gradeData">
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped grade-distribution-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="grade-column">Grade</th>
                        {% for section in sections %}
                                        <th class="section-column">Section{{ section.section_number }}</th>
                                        {% endfor %}
                                        <th class="total-column">Total</th>
                                        <th class="frequency-column">Frequency (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for grade_info in grade_categories %}
                                    <tr>
                                        <td class="grade-column">
                                            <strong>{{ grade_info.grade }}</strong><br>
                                            <small class="text-muted">
                                                {% if grade_info.grade == 'A' %}
                                                    92.5% to 100%
                                                {% elif grade_info.grade == 'A-' %}
                                                    89.5% to less than 92.5%
                                                {% elif grade_info.grade == 'B+' %}
                                                    86.5% to less than 89.5%
                                                {% elif grade_info.grade == 'B' %}
                                                    82.5% to less than 86.5%
                                                {% elif grade_info.grade == 'B-' %}
                                                    79.5% to less than 82.5%
                                                {% elif grade_info.grade == 'C+' %}
                                                    76.5% to less than 79.5%
                                                {% elif grade_info.grade == 'C' %}
                                                    72.5% to less than 76.5%
                                                {% elif grade_info.grade == 'C-' %}
                                                    69.5% to less than 72.5%
                                                {% elif grade_info.grade == 'D' %}
                                                    59.5% to less than 69.5%
                                                {% elif grade_info.grade == 'F' %}
                                                    Less than 59.5%
                                                {% else %}
                                                    {{ grade_info.range }}
                                                {% endif %}
                                            </small>
                                        </td>
                                        {% for section in sections %}
                                        <td>
                                            {% if existing_grade_data %}
                                                {% with section_data=existing_grade_data %}
                                                    {% with grade_count=section_data|lookup:section.id|lookup:grade_info.grade|default:0 %}
                                                        <input type="number" class="form-control grade-input" 
                                                               name="grade_{{ section.id }}_{{ grade_info.grade }}" 
                                                               value="{{ grade_count }}" min="0" 
                                                               data-grade="{{ grade_info.grade }}" 
                                                               data-section="{{ section.id }}">
                                                    {% endwith %}
                                                {% endwith %}
                                            {% else %}
                                                <input type="number" class="form-control grade-input" 
                                                       name="grade_{{ section.id }}_{{ grade_info.grade }}" 
                                                       value="0" min="0" 
                                                       data-grade="{{ grade_info.grade }}" 
                                                       data-section="{{ section.id }}">
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                        <td class="total-cell" data-grade="{{ grade_info.grade }}">
                                            <span class="total-value">0</span>
                                        </td>
                                        <td class="frequency-cell" data-grade="{{ grade_info.grade }}">
                                            <span class="frequency-value">0.00</span>
                                        </td>
                                        </tr>
                                    {% endfor %}
                                    <tr class="table-info">
                                        <td><strong>Section Totals</strong></td>
                                        {% for section in sections %}
                                        <td class="section-total" data-section="{{ section.id }}">
                                            <span class="section-total-value">0</span>
                                        </td>
                                        {% endfor %}
                                        <td class="grand-total">
                                            <span class="grand-total-value">0</span>
                                        </td>
                                        <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="saveGradeData('back')">
                                <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="saveGradeData('save')">
                                    <i class="fas fa-save me-2"></i>Save
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-arrow-right me-2"></i>Next: Generate Report
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Distribution Chart -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Grade Distribution Chart
                    </h5>
                </div>
                <div class="card-body">
                    <div id="gradeDistributionChart" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for charts
let gradeDistributionChart = null;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeGradeDistributionChart();
    updateTableCalculations();
    
    // Update chart with existing data after a short delay to ensure DOM is ready
    setTimeout(() => {
        updateGradeDistributionChart();
    }, 100);
    
    // Add event listeners to all grade inputs for automatic updates
    const inputs = document.querySelectorAll('.grade-input');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            updateTableCalculations();
            updateGradeDistributionChart();
            
            // Trigger auto-save after a short delay
            clearTimeout(window.autoSaveTimeout);
            window.autoSaveTimeout = setTimeout(() => {
                autoSaveGradeData();
            }, 2000); // Auto-save 2 seconds after user stops typing
        });
    });
    
    // Initialize auto-save status indicator
    initializeAutoSaveStatus();
});

function initializeGradeDistributionChart() {
    // Initialize empty grade distribution chart
    const gradeDistributionData = [];
    const gradeDistributionLayout = {
        title: 'Grade Distribution',
        xaxis: { title: 'Grade' },
        yaxis: { title: 'Number of Students', side: 'left' },
        yaxis2: {
            title: 'Frequency (%)',
            side: 'right',
            overlaying: 'y',
            range: [0, 100]
        },
        barmode: 'stack',
        showlegend: true,
        height: 500
    };
    
    gradeDistributionChart = Plotly.newPlot('gradeDistributionChart', gradeDistributionData, gradeDistributionLayout);
}

function updateTableCalculations() {
    // Calculate totals and frequencies for the table
    const gradeCategories = Array.from(new Set(Array.from(document.querySelectorAll('.grade-input')).map(input => input.dataset.grade)));
    const sections = Array.from(new Set(Array.from(document.querySelectorAll('.grade-input')).map(input => input.dataset.section)));
    
    let grandTotal = 0;
    
    // Calculate totals for each grade
    gradeCategories.forEach(grade => {
        let gradeTotal = 0;
        sections.forEach(sectionId => {
            const input = document.querySelector(`input[data-grade="${grade}"][data-section="${sectionId}"]`);
            if (input) {
                gradeTotal += parseInt(input.value) || 0;
            }
        });
        
        // Update total cell
        const totalCell = document.querySelector(`.total-cell[data-grade="${grade}"] .total-value`);
        if (totalCell) {
            totalCell.textContent = gradeTotal;
        }
        
        grandTotal += gradeTotal;
    });
    
    // Calculate frequencies
    gradeCategories.forEach(grade => {
        const totalCell = document.querySelector(`.total-cell[data-grade="${grade}"] .total-value`);
        const frequencyCell = document.querySelector(`.frequency-cell[data-grade="${grade}"] .frequency-value`);
        
        if (totalCell && frequencyCell) {
            const gradeTotal = parseInt(totalCell.textContent) || 0;
            const frequency = grandTotal > 0 ? ((gradeTotal / grandTotal) * 100).toFixed(2) : '0.00';
            frequencyCell.textContent = frequency;
        }
    });
    
    // Calculate section totals
    sections.forEach(sectionId => {
        let sectionTotal = 0;
        gradeCategories.forEach(grade => {
            const input = document.querySelector(`input[data-grade="${grade}"][data-section="${sectionId}"]`);
            if (input) {
                sectionTotal += parseInt(input.value) || 0;
            }
        });
        
        const sectionTotalCell = document.querySelector(`.section-total[data-section="${sectionId}"] .section-total-value`);
        if (sectionTotalCell) {
            sectionTotalCell.textContent = sectionTotal;
        }
    });
    
    // Update grand total
    const grandTotalCell = document.querySelector('.grand-total .grand-total-value');
    if (grandTotalCell) {
        grandTotalCell.textContent = grandTotal;
    }
}

function updateGradeDistributionChart() {
    // Collect current grade data from the table
    const gradeData = {};
    const inputs = document.querySelectorAll('.grade-input');
    
    inputs.forEach(input => {
        const sectionId = input.dataset.section;
        const grade = input.dataset.grade;
        const count = parseInt(input.value) || 0;
        
        if (!gradeData[sectionId]) {
            gradeData[sectionId] = {};
        }
        gradeData[sectionId][grade] = count;
    });
    
    // Get grade categories and sections
    const grades = Array.from(new Set(Array.from(document.querySelectorAll('.grade-input')).map(input => input.dataset.grade)));
    const sections = Object.keys(gradeData).sort();
    
    if (grades.length === 0 || sections.length === 0) {
        // Show empty chart with message if no data
        Plotly.newPlot('gradeDistributionChart', [], {
            title: 'Grade Distribution',
            xaxis: { title: 'Grade' },
            yaxis: { title: 'Number of Students', side: 'left' },
            yaxis2: {
                title: 'Frequency (%)',
                side: 'right',
                overlaying: 'y',
                range: [0, 100]
            },
            annotations: [{
                x: 0.5,
                y: 0.5,
                xref: 'paper',
                yref: 'paper',
                text: 'Enter grade data to see the chart',
                showarrow: false,
                font: { size: 16, color: '#666' }
            }],
            showlegend: false,
            height: 500
        });
        return;
    }
    
    // Define colors for sections (20 unique colors)
    const sectionColors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#FF9F43', '#10AC84', '#EE5A24', '#0984E3', '#6C5CE7',
        '#A29BFE', '#FD79A8', '#FDCB6E', '#E17055', '#00B894'
    ];
    
    // Create chart data
    const chartData = [];
    
    // Add bar data for each section
    sections.forEach((sectionId, index) => {
        const sectionGrades = gradeData[sectionId] || {};
        const sectionData = grades.map(grade => sectionGrades[grade] || 0);
        
        // Get the actual section number from the table headers
        const sectionHeaders = document.querySelectorAll('.section-column');
        const sectionNumber = sectionHeaders[index] ? sectionHeaders[index].textContent.replace('Section', '').trim() : (index + 1);
        
        chartData.push({
            x: grades,
            y: sectionData,
            type: 'bar',
            name: `Section ${sectionNumber}`,
            marker: { 
                color: sectionColors[index % sectionColors.length],
                line: { color: sectionColors[index % sectionColors.length], width: 2 }
            },
            text: sectionData,
            textposition: 'inside'
        });
    });
    
    // Calculate frequencies for line chart (total students across all sections)
    const totalCounts = grades.map(grade => {
        return sections.reduce((sum, sectionId) => {
            return sum + (gradeData[sectionId]?.[grade] || 0);
        }, 0);
    });
    
    const totalStudents = totalCounts.reduce((sum, count) => sum + count, 0);
    const frequencies = totalCounts.map(count => 
        totalStudents > 0 ? Math.round((count / totalStudents) * 100 * 10) / 10 : 0
    );
    
    // Add frequency line without text labels
    chartData.push({
        x: grades,
        y: frequencies,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Frequency (%)',
        yaxis: 'y2',
        line: { color: '#FF0000', width: 3 },
        marker: { color: '#FF0000', size: 8 }
    });
    
    // Create separate text annotations for frequency values positioned above the bar graph (same strategy as PDF)
    // Calculate the maximum bar height to position labels above bars
    const maxBarHeight = Math.max(...totalCounts);
    const frequencyAnnotations = grades.map((grade, index) => ({
        x: grade,
        y: totalCounts[index] + (maxBarHeight * 0.08), // Position above bar graph with 8% spacing (same as PDF)
        xref: 'x',
        yref: 'y', // Use left y-axis (bar graph axis) instead of right y-axis (frequency axis)
        text: frequencies[index].toFixed(1) + '%',
        showarrow: false,
        font: { color: '#000000', size: 12, family: 'Arial, sans-serif' },
        bgcolor: 'rgba(255,255,255,0.9)',
        bordercolor: 'rgba(0,0,0,0.1)',
        borderwidth: 1,
        borderpad: 4
    }));
    
    // Update the chart
    Plotly.newPlot('gradeDistributionChart', chartData, {
        title: {
            text: 'Grade Distribution',
            x: 0.5,
            xanchor: 'center',
            y: 0.95,
            yanchor: 'top'
        },
        xaxis: { title: 'Grade' },
        yaxis: { title: 'Number of Students', side: 'left' },
        yaxis2: {
            title: 'Frequency (%)',
            side: 'right',
            overlaying: 'y',
            range: [0, Math.max(100, Math.max(...frequencies) + 15)] // Increased range to accommodate text
        },
        barmode: 'stack',
        showlegend: true,
        legend: {
            orientation: 'h',
            x: 0.5,
            xanchor: 'center',
            y: 1.0,
            yanchor: 'bottom'
        },
        annotations: frequencyAnnotations, // Add frequency text annotations
        height: 500,
        margin: {
            t: 120  // Increased top margin to prevent overlap
        }
    });
}

// Form submission with save functionality
document.getElementById('gradeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const gradeData = {};
    
    // Collect all grade data
    const inputs = document.querySelectorAll('input[name^="grade_"]');
    inputs.forEach(input => {
        const nameParts = input.name.split('_');
        if (nameParts.length >= 3) {
            const sectionId = nameParts[1];
            const grade = nameParts.slice(2).join('_');
        const count = parseInt(input.value) || 0;
        
            if (!isNaN(sectionId) && count > 0) {
        if (!gradeData[sectionId]) {
            gradeData[sectionId] = {};
        }
            gradeData[sectionId][grade] = count;
            }
        }
    });
    
    // Set the hidden input value
    document.getElementById('gradeData').value = JSON.stringify(gradeData);
    
    // Submit the form
    this.submit();
});

// Add save functionality for back/next buttons
function saveGradeData(action) {
    const gradeData = {};
    
    // Collect all grade data
    const inputs = document.querySelectorAll('input[name^="grade_"]');
    inputs.forEach(input => {
        const nameParts = input.name.split('_');
        if (nameParts.length >= 3) {
            const sectionId = nameParts[1];
            const grade = nameParts.slice(2).join('_');
            const count = parseInt(input.value) || 0;
            
            if (!isNaN(sectionId) && count > 0) {
                if (!gradeData[sectionId]) {
                    gradeData[sectionId] = {};
                }
                gradeData[sectionId][grade] = count;
            }
        }
    });
    
    // Create a form to submit the data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = window.location.href;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Add grade data
    const gradeDataInput = document.createElement('input');
    gradeDataInput.type = 'hidden';
    gradeDataInput.name = 'grade_data';
    gradeDataInput.value = JSON.stringify(gradeData);
    form.appendChild(gradeDataInput);
    
    // Add action
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    form.appendChild(actionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Auto-save functionality
function autoSaveGradeData() {
    const gradeData = {};
    
    // Collect all grade data
    const inputs = document.querySelectorAll('input[name^="grade_"]');
    inputs.forEach(input => {
        const nameParts = input.name.split('_');
        if (nameParts.length >= 3) {
            const sectionId = nameParts[1];
            const grade = nameParts.slice(2).join('_');
            const count = parseInt(input.value) || 0;
            
            if (!isNaN(sectionId)) {
                if (!gradeData[sectionId]) {
                    gradeData[sectionId] = {};
                }
                gradeData[sectionId][grade] = count;
            }
        }
    });
    
    // Get course ID from URL
    const courseId = window.location.pathname.split('/')[2];
    
    // Show saving status
    updateAutoSaveStatus('saving', 'Saving...');
    
    // Send auto-save request
    fetch('/api/save-grade-distribution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            course_id: courseId,
            grade_data: gradeData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateAutoSaveStatus('saved', 'Data auto-saved');
        } else {
            updateAutoSaveStatus('error', 'Auto-save failed');
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
        updateAutoSaveStatus('error', 'Auto-save failed');
    });
}

// Auto-save status indicator
function initializeAutoSaveStatus() {
    // Create status indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'auto-save-status';
    statusDiv.className = 'auto-save-status';
    statusDiv.innerHTML = '<i class="fas fa-circle"></i> <span>Ready</span>';
    
    // Add to header
    const header = document.querySelector('.card-body .d-flex');
    if (header) {
        header.appendChild(statusDiv);
    }
}

function updateAutoSaveStatus(status, message) {
    const statusDiv = document.getElementById('auto-save-status');
    if (!statusDiv) return;
    
    const icon = statusDiv.querySelector('i');
    const text = statusDiv.querySelector('span');
    
    // Remove existing classes
    statusDiv.className = 'auto-save-status';
    
    switch(status) {
        case 'saving':
            statusDiv.classList.add('saving');
            icon.className = 'fas fa-spinner fa-spin';
            text.textContent = 'Saving...';
            break;
        case 'saved':
            statusDiv.classList.add('saved');
            icon.className = 'fas fa-check-circle';
            text.textContent = message || 'Saved';
            // Hide after 3 seconds
            setTimeout(() => {
                if (statusDiv.classList.contains('saved')) {
                    statusDiv.classList.remove('saved');
                    icon.className = 'fas fa-circle';
                    text.textContent = 'Ready';
                }
            }, 3000);
            break;
        case 'error':
            statusDiv.classList.add('error');
            icon.className = 'fas fa-exclamation-circle';
            text.textContent = message || 'Error';
            // Hide after 5 seconds
            setTimeout(() => {
                if (statusDiv.classList.contains('error')) {
                    statusDiv.classList.remove('error');
                    icon.className = 'fas fa-circle';
                    text.textContent = 'Ready';
                }
            }, 5000);
            break;
        default:
            icon.className = 'fas fa-circle';
            text.textContent = message || 'Ready';
    }
}
</script>

<style>
/* Grade Distribution Table Styling */
.grade-distribution-table {
    font-size: 0.9em;
}

.grade-distribution-table .grade-column {
    width: 200px;
    min-width: 200px;
    text-align: left;
    vertical-align: middle;
}

.grade-distribution-table .section-column {
    width: 120px;
    min-width: 120px;
    text-align: center;
    vertical-align: middle;
}

.grade-distribution-table .total-column {
    width: 80px;
    min-width: 80px;
    text-align: center;
    vertical-align: middle;
}

.grade-distribution-table .frequency-column {
    width: 100px;
    min-width: 100px;
    text-align: center;
    vertical-align: middle;
}

.grade-distribution-table .grade-input {
    width: 80px;
    text-align: center;
    margin: 0 auto;
    display: block;
}

.grade-distribution-table th {
    text-align: center;
    vertical-align: middle;
    font-weight: 600;
}

.grade-distribution-table td {
    vertical-align: middle;
}

.auto-save-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9em;
    padding: 5px 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.auto-save-status.saving {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.auto-save-status.saved {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.auto-save-status.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.auto-save-status i {
    font-size: 0.8em;
}
</style>
{% endblock %}
